{% extends "base.html" %}

{% block title %}电子地图 - 高速公路集中养护智能管理系统{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<!-- 添加Leaflet.markercluster样式 -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    #map-container {
        height: 600px;
        width: 100%;
    }
    .legend {
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .legend-item {
        margin-bottom: 5px;
    }
    .legend-color {
        display: inline-block;
        width: 16px;
        height: 16px;
        margin-right: 8px;
        border-radius: 50%;
    }
    .task-popup {
        max-width: 300px;
    }
    .task-popup h5 {
        margin-top: 0;
        margin-bottom: 10px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }
    .task-popup-details {
        margin-bottom: 5px;
    }
    .task-impact-high {
        color: #dc3545;
        font-weight: bold;
    }
    .task-impact-medium {
        color: #fd7e14;
        font-weight: bold;
    }
    .task-impact-low {
        color: #28a745;
        font-weight: bold;
    }
    /* 加载指示器样式 */
    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255,255,255,0.8);
        padding: 20px;
        border-radius: 5px;
        z-index: 1000;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .spinner-border {
        width: 2rem;
        height: 2rem;
    }
    /* 错误提示样式 */
    .map-error {
        color: #dc3545;
        background: #fff;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .retry-button {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>电子地图</h2>
        <div>
            <a href="{{ url_for('visualization_dashboard') }}" class="btn btn-secondary">返回可视化展示</a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">图层控制</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="layer-tasks" checked>
                        <label class="form-check-label" for="layer-tasks">
                            施工任务
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="layer-resources" checked>
                        <label class="form-check-label" for="layer-resources">
                            资源分布
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="layer-traffic">
                        <label class="form-check-label" for="layer-traffic">
                            交通状况
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="layer-closures">
                        <label class="form-check-label" for="layer-closures">
                            封路区域
                        </label>
                    </div>

                    <hr>

                    <h6>任务类型筛选</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="filter-all" checked>
                        <label class="form-check-label" for="filter-all">
                            全部类型
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input task-type-filter" type="checkbox" id="filter-road" checked>
                        <label class="form-check-label" for="filter-road">
                            道路养护
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input task-type-filter" type="checkbox" id="filter-bridge" checked>
                        <label class="form-check-label" for="filter-bridge">
                            桥梁维护
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input task-type-filter" type="checkbox" id="filter-tunnel" checked>
                        <label class="form-check-label" for="filter-tunnel">
                            隧道维护
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input task-type-filter" type="checkbox" id="filter-facility" checked>
                        <label class="form-check-label" for="filter-facility">
                            设施维护
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-body p-0 position-relative">
                    <!-- 加载指示器 -->
                    <div id="loading-indicator" class="loading-indicator">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary me-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>地图数据加载中...</span>
                        </div>
                    </div>
                    <div id="map-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">当前施工详情</h5>
                    <div>
                        <span id="last-update-time" class="text-muted me-2 small"></span>
                        <button class="btn btn-sm btn-outline-primary" id="load-table-data">
                            <i class="fas fa-sync-alt me-1"></i>刷新数据
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="active-tasks-table">
                            <thead>
                                <tr>
                                    <th>任务名称</th>
                                    <th>位置</th>
                                    <th>任务类型</th>
                                    <th>状态</th>
                                    <th>交通影响</th>
                                    <th>优先级</th>
                                    <th>开始时间</th>
                                    <th>结束时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 动态加载内容 -->
                                <tr><td colspan="9" class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-status-active" checked>
                            <label class="form-check-label" for="filter-status-active">进行中</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-status-pending" checked>
                            <label class="form-check-label" for="filter-status-pending">待处理</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-status-completed">
                            <label class="form-check-label" for="filter-status-completed">已完成</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-status-canceled">
                            <label class="form-check-label" for="filter-status-canceled">已取消</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!-- 添加Leaflet.markercluster插件 -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 首先从服务器获取地图配置
        fetch('/api/map_config')
            .then(response => response.json())
            .then(config => {
                initMap(config);
            })
            .catch(error => {
                console.error('无法获取地图配置:', error);
                // 使用默认配置初始化地图
                initMap({
                    provider: 'gaode',
                    tianditu_key: '',
                    center: [22.54, 114.05],
                    zoom: 9
                });
            });
        
        function initMap(config) {
            // 初始化地图 - 使用配置中的中心点和缩放级别
            const map = L.map('map-container', {
                preferCanvas: true, // 使用Canvas渲染器提高性能
                attributionControl: false, // 移除归属控件，稍后添加
                zoomControl: false // 移除默认缩放控件，稍后重新添加
            }).setView(config.center, config.zoom);
            
            // 单独添加缩放控件
            L.control.zoom({
                position: 'topleft'
            }).addTo(map);
            
            // 单独添加归属控件
            L.control.attribution({
                position: 'bottomright'
            }).addTo(map);
            
            // 尝试多个地图瓦片源，如果一个失败则尝试下一个
            let tileLayerAdded = false;
            
            // 根据配置选择地图提供商
            switch(config.provider) {
                case 'tianditu':
                    addTiandituLayer(config.tianditu_key);
                    break;
                case 'gaode':
                default:
                    addGaodeLayer();
                    break;
            }
            
            // 天地图矢量瓦片 - 使用配置中的密钥
            function addTiandituLayer(tiandituKey) {
                if (!tiandituKey) {
                    console.log('天地图密钥未配置，尝试高德地图');
                    addGaodeLayer();
                    return;
                }
                
                try {
                    const tiandituLayer = L.tileLayer('https://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=' + tiandituKey, {
                        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
                        attribution: '&copy; 天地图',
                        maxZoom: 18
                    });
                    
                    tiandituLayer.on('tileerror', function() {
                        if (!tileLayerAdded) {
                            console.log('天地图加载失败，尝试高德地图');
                            addGaodeLayer();
                        }
                    });
                    
                    tiandituLayer.on('load', function() {
                        tileLayerAdded = true;
                    });
                    
                    tiandituLayer.addTo(map);
                    
                    // 添加天地图标注层
                    L.tileLayer('https://t{s}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=' + tiandituKey, {
                        subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
                        maxZoom: 18
                    }).addTo(map);
                    
                } catch (e) {
                    console.error('天地图加载错误:', e);
                    addGaodeLayer();
                }
            }
            
            // 高德地图瓦片
            function addGaodeLayer() {
                try {
                    const gaodeLayer = L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                        subdomains: ["1", "2", "3", "4"],
                        attribution: '&copy; 高德地图',
                        maxZoom: 18
                    });
                    
                    gaodeLayer.on('tileerror', function() {
                        if (!tileLayerAdded) {
                            console.log('高德地图加载失败，尝试备用OpenStreetMap');
                            addOsmLayer();
                        }
                    });
                    
                    gaodeLayer.on('load', function() {
                        tileLayerAdded = true;
                        // 隐藏加载指示器
                        hideLoadingAfterDelay(1000);
                    });
                    
                    gaodeLayer.addTo(map);
                } catch (e) {
                    console.error('高德地图加载错误:', e);
                    addOsmLayer();
                }
            }
            
            // 备用OpenStreetMap瓦片
            function addOsmLayer() {
                try {
                    // 使用可能对中国用户更友好的OSM镜像
                    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19,
                        minZoom: 3
                    });
                    
                    osmLayer.on('tileerror', function() {
                        if (!tileLayerAdded) {
                            showMapError();
                        }
                    });
                    
                    osmLayer.on('load', function() {
                        tileLayerAdded = true;
                        // 隐藏加载指示器
                        hideLoadingAfterDelay(1000);
                    });
                    
                    osmLayer.addTo(map);
                } catch (e) {
                    console.error('OSM加载错误:', e);
                    showMapError();
                }
            }
            
            // 显示地图错误
            function showMapError() {
                document.getElementById('loading-indicator').innerHTML = `
                    <div class="map-error">
                        <div><i class="fas fa-exclamation-triangle mr-2"></i>地图瓦片加载失败</div>
                        <div class="mt-2">请检查网络连接或稍后再试</div>
                        <button class="btn btn-sm btn-primary retry-button" onclick="window.location.reload()">重试</button>
                    </div>
                `;
            }
            
            // 延迟隐藏加载指示器，确保至少有几个瓦片已加载
            function hideLoadingAfterDelay(delay) {
                setTimeout(function() {
                    document.getElementById('loading-indicator').style.display = 'none';
                }, delay);
            }
            
            // 创建图层组
            const markerClusterGroup = L.markerClusterGroup({
                chunkedLoading: true,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                maxClusterRadius: 50
            });
            
            const resourcesLayer = L.markerClusterGroup({
                chunkedLoading: true,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false
            });
            
            const tasksLayer = L.featureGroup();
            const trafficLayer = L.layerGroup();
            const closuresLayer = L.layerGroup();
            
            // 最终将聚合图层添加到地图
            map.addLayer(markerClusterGroup);
            
            // 设置任务标记的图标 - 简化图标创建
            const taskIcons = {
                'high': L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background-color: #dc3545; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                }),
                'medium': L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background-color: #fd7e14; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                }),
                'low': L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background-color: #28a745; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            };
            
            // 设置资源标记的选项
            const resourceStyles = {
                '人员': { color: '#fff', fillColor: '#007bff', radius: 6, weight: 1, fillOpacity: 0.8 },
                '设备': { color: '#fff', fillColor: '#6f42c1', radius: 6, weight: 1, fillOpacity: 0.8 },
                '材料': { color: '#fff', fillColor: '#20c997', radius: 6, weight: 1, fillOpacity: 0.8 }
            };
            
            let mapData = null;
            
            // 加载地图数据 - 使用Promise和延迟加载
            const loadMapData = () => {
                return new Promise((resolve, reject) => {
                    fetch('/api/map_data')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            mapData = data;
                            resolve(data);
                        })
                        .catch(error => {
                            console.error('Error loading map data:', error);
                            reject(error);
                        });
                });
            };
            
            // 处理任务数据
            const processTasks = (tasks) => {
                tasks.forEach(task => {
                    // 根据影响程度选择图标
                    let icon;
                    if (task.traffic_impact === '高') {
                        icon = taskIcons.high;
                    } else if (task.traffic_impact === '中') {
                        icon = taskIcons.medium;
                    } else {
                        icon = taskIcons.low;
                    }
                    
                    const taskMarker = L.marker([task.latitude, task.longitude], {
                        icon: icon,
                        taskType: task.type
                    });
                    
                    // 简化的弹出窗口内容
                    const impactClass = task.traffic_impact === '高' ? 'task-impact-high' : 
                                      (task.traffic_impact === '中' ? 'task-impact-medium' : 'task-impact-low');
                    
                    taskMarker.bindPopup(`
                        <div class="task-popup">
                            <h5>${task.name}</h5>
                            <div class="task-popup-details"><strong>位置:</strong> ${task.location}</div>
                            <div class="task-popup-details"><strong>类型:</strong> ${task.type}</div>
                            <div class="task-popup-details"><strong>状态:</strong> ${task.status}</div>
                            <div class="task-popup-details">
                                <strong>交通影响:</strong> 
                                <span class="${impactClass}">${task.traffic_impact}</span>
                            </div>
                            <div class="mt-2">
                                <a href="/task/${task.id}" class="btn btn-sm btn-primary">查看详情</a>
                            </div>
                        </div>
                    `, {
                        maxWidth: 300,
                        autoPanPadding: [40, 40]
                    });
                    
                    markerClusterGroup.addLayer(taskMarker);
                    tasksLayer.addLayer(taskMarker);
                });
            };
            
            // 处理资源数据
            const processResources = (resources) => {
                resources.forEach(resource => {
                    const style = resourceStyles[resource.type] || resourceStyles['材料'];
                    
                    const resourceMarker = L.circleMarker([resource.latitude, resource.longitude], style);
                    
                    resourceMarker.bindPopup(`
                        <div>
                            <h6>${resource.name}</h6>
                            <div><strong>类型:</strong> ${resource.type}</div>
                            <div><strong>状态:</strong> ${resource.status}</div>
                            <div><strong>位置:</strong> ${resource.location}</div>
                        </div>
                    `, {
                        maxWidth: 300
                    });
                    
                    resourcesLayer.addLayer(resourceMarker);
                });
            };
            
            // 异步加载地图数据并初始化
            loadMapData()
                .then(data => {
                    // 处理任务标记
                    processTasks(data.tasks);
                    
                    // 处理资源标记
                    processResources(data.resources);
                    
                    // 添加模拟的封闭区域
                    createSimulatedClosures();
                    
                    // 添加模拟的交通状况
                    createSimulatedTraffic();
                    
                    // 完成后隐藏加载指示器
                    document.getElementById('loading-indicator').style.display = 'none';
                    
                    // 添加图例
                    addMapLegend();
                    
                    // 设置图层控制事件
                    setupLayerControls();
                    
                    // 适应所有标记的边界
                    const bounds = markerClusterGroup.getBounds();
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, {
                            padding: [50, 50]
                        });
                    }
                    
                    // 初始化状态筛选器
                    document.getElementById('filter-status-active').checked = true;
                    document.getElementById('filter-status-pending').checked = true;
                    document.getElementById('filter-status-completed').checked = false;
                    document.getElementById('filter-status-canceled').checked = false;
                    
                    // 自动加载表格数据
                    loadTableData();
                    
                    // 设置定时刷新 - 每3分钟刷新一次数据
                    setInterval(loadTableData, 180000);
                })
                .catch(error => {
                    console.error('Failed to load map data:', error);
                    document.getElementById('loading-indicator').innerHTML = 
                        `<div class="text-danger">加载数据失败，请刷新页面重试</div>`;
                });
            
            // 模拟封闭区域
            function createSimulatedClosures() {
                // 简化的封闭区域
                const closure1 = L.polygon([
                    [22.52, 114.05],
                    [22.53, 114.06],
                    [22.51, 114.07]
                ], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.3,
                    weight: 2
                }).bindPopup('莞深高速K15+300段封路区域');
                
                const closure2 = L.polygon([
                    [22.56, 114.12],
                    [22.57, 114.13],
                    [22.55, 114.14]
                ], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.3,
                    weight: 2
                }).bindPopup('龙林高速S22桥梁封路区域');
                
                closuresLayer.addLayer(closure1);
                closuresLayer.addLayer(closure2);
            }
            
            // 模拟交通状况
            function createSimulatedTraffic() {
                // 简化的交通线路
                const trafficLine1 = L.polyline([
                    [22.50, 114.00],
                    [22.51, 114.02],
                    [22.52, 114.05]
                ], {
                    color: 'red',
                    weight: 5,
                    opacity: 0.7
                }).bindPopup('交通拥堵');
                
                const trafficLine2 = L.polyline([
                    [22.53, 114.07],
                    [22.54, 114.10]
                ], {
                    color: 'orange',
                    weight: 5,
                    opacity: 0.7
                }).bindPopup('交通缓慢');
                
                const trafficLine3 = L.polyline([
                    [22.55, 114.12],
                    [22.56, 114.15]
                ], {
                    color: 'green',
                    weight: 5,
                    opacity: 0.7
                }).bindPopup('交通畅通');
                
                trafficLayer.addLayer(trafficLine1);
                trafficLayer.addLayer(trafficLine2);
                trafficLayer.addLayer(trafficLine3);
            }
            
            // 添加地图图例
            function addMapLegend() {
                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function(map) {
                    const div = L.DomUtil.create('div', 'legend');
                    div.innerHTML = `
                        <h6 class="mb-2">图例</h6>
                        <div class="legend-item"><span class="legend-color" style="background-color: #dc3545;"></span>高影响任务</div>
                        <div class="legend-item"><span class="legend-color" style="background-color: #fd7e14;"></span>中影响任务</div>
                        <div class="legend-item"><span class="legend-color" style="background-color: #28a745;"></span>低影响任务</div>
                        <div class="legend-item"><span class="legend-color" style="background-color: #007bff;"></span>人员资源</div>
                        <div class="legend-item"><span class="legend-color" style="background-color: #6f42c1;"></span>设备资源</div>
                        <div class="legend-item"><span class="legend-color" style="background-color: #20c997;"></span>材料资源</div>
                    `;
                    return div;
                };
                legend.addTo(map);
            }
            
            // 设置图层控制事件
            function setupLayerControls() {
                document.getElementById('layer-tasks').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(markerClusterGroup);
                    } else {
                        map.removeLayer(markerClusterGroup);
                    }
                });
                
                document.getElementById('layer-resources').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(resourcesLayer);
                    } else {
                        map.removeLayer(resourcesLayer);
                    }
                });
                
                document.getElementById('layer-traffic').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(trafficLayer);
                    } else {
                        map.removeLayer(trafficLayer);
                    }
                });
                
                document.getElementById('layer-closures').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(closuresLayer);
                    } else {
                        map.removeLayer(closuresLayer);
                    }
                });
                
                // 任务类型筛选
                document.getElementById('filter-all').addEventListener('change', function() {
                    const checked = this.checked;
                    document.querySelectorAll('.task-type-filter').forEach(checkbox => {
                        checkbox.checked = checked;
                    });
                    filterTasks();
                });
                
                // 为每个任务类型筛选器添加事件
                document.querySelectorAll('.task-type-filter').forEach(checkbox => {
                    checkbox.addEventListener('change', filterTasks);
                });
            }
            
            // 筛选任务函数
            function filterTasks() {
                const roadChecked = document.getElementById('filter-road').checked;
                const bridgeChecked = document.getElementById('filter-bridge').checked;
                const tunnelChecked = document.getElementById('filter-tunnel').checked;
                const facilityChecked = document.getElementById('filter-facility').checked;
                
                // 重置集群
                markerClusterGroup.clearLayers();
                
                // 根据选择添加任务
                tasksLayer.eachLayer(function(layer) {
                    const taskType = layer.options.taskType;
                    let shouldAdd = false;
                    
                    if (taskType === '道路养护' && roadChecked) shouldAdd = true;
                    else if (taskType === '桥梁维护' && bridgeChecked) shouldAdd = true;
                    else if (taskType === '隧道维护' && tunnelChecked) shouldAdd = true;
                    else if (taskType === '设施维护' && facilityChecked) shouldAdd = true;
                    
                    if (shouldAdd) {
                        markerClusterGroup.addLayer(layer);
                    }
                });
            }
            
            // 延迟加载表格数据
            document.getElementById('load-table-data').addEventListener('click', function() {
                loadTableData();
            });
            
            // 加载表格数据函数
            function loadTableData() {
                const loadButton = document.getElementById('load-table-data');
                loadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>加载中...';
                loadButton.disabled = true;
                
                // 重新获取最新的地图数据
                fetch('/api/map_data')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 更新全局地图数据
                        mapData = data;
                        
                        // 渲染表格数据
                        renderTableData();
                        
                        // 更新地图上的标记
                        updateMapMarkers(data);
                        
                        // 更新按钮状态
                        loadButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i>刷新数据';
                        loadButton.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error loading table data:', error);
                        loadButton.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>加载失败';
                        loadButton.disabled = false;
                        setTimeout(() => {
                            loadButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i>重试';
                        }, 2000);
                    });
            }
            
            // 渲染表格数据函数
            function renderTableData() {
                if (!mapData || !mapData.tasks) {
                    return;
                }
                
                const tableBody = document.querySelector('#active-tasks-table tbody');
                let tableHtml = '';
                
                // 更新最后刷新时间
                const lastUpdateTimeElement = document.getElementById('last-update-time');
                const now = new Date();
                lastUpdateTimeElement.textContent = `最后更新: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                
                // 根据任务状态排序：进行中 > 待处理 > 已完成 > 已取消
                const statusOrder = {
                    '进行中': 0,
                    '待处理': 1,
                    '已完成': 2,
                    '已取消': 3
                };
                
                // 获取状态筛选条件
                const showActive = document.getElementById('filter-status-active').checked;
                const showPending = document.getElementById('filter-status-pending').checked;
                const showCompleted = document.getElementById('filter-status-completed').checked;
                const showCanceled = document.getElementById('filter-status-canceled').checked;
                
                // 对任务进行排序
                const sortedTasks = [...mapData.tasks].sort((a, b) => {
                    // 首先按状态排序
                    const statusA = statusOrder[a.status] !== undefined ? statusOrder[a.status] : 99;
                    const statusB = statusOrder[b.status] !== undefined ? statusOrder[b.status] : 99;
                    
                    if (statusA !== statusB) {
                        return statusA - statusB;
                    }
                    
                    // 然后按优先级排序（高优先级在前）
                    const priorityA = a.priority || 0;
                    const priorityB = b.priority || 0;
                    
                    return priorityB - priorityA;
                });
                
                // 筛选并渲染任务
                const filteredTasks = sortedTasks.filter(task => {
                    if (task.status === '进行中' && showActive) return true;
                    if (task.status === '待处理' && showPending) return true;
                    if (task.status === '已完成' && showCompleted) return true;
                    if (task.status === '已取消' && showCanceled) return true;
                    return false;
                });
                
                if (filteredTasks.length === 0) {
                    tableHtml = `<tr><td colspan="9" class="text-center py-3">没有符合条件的任务</td></tr>`;
                } else {
                    filteredTasks.forEach(task => {
                        const impactClass = task.traffic_impact === '高' ? 'text-danger' : 
                                          (task.traffic_impact === '中' ? 'text-warning' : 'text-success');
                        
                        // 根据任务状态设置样式
                        let statusClass = '';
                        switch(task.status) {
                            case '进行中':
                                statusClass = 'text-primary fw-bold';
                                break;
                            case '待处理':
                                statusClass = 'text-secondary';
                                break;
                            case '已完成':
                                statusClass = 'text-success';
                                break;
                            case '已取消':
                                statusClass = 'text-danger';
                                break;
                            default:
                                statusClass = '';
                        }
                        
                        // 根据优先级设置样式
                        let priorityText = '';
                        let priorityClass = '';
                        if (task.priority) {
                            if (task.priority >= 8) {
                                priorityText = '高';
                                priorityClass = 'text-danger fw-bold';
                            } else if (task.priority >= 4) {
                                priorityText = '中';
                                priorityClass = 'text-warning fw-bold';
                            } else {
                                priorityText = '低';
                                priorityClass = 'text-success';
                            }
                        } else {
                            priorityText = '未定';
                        }
                        
                        tableHtml += `
                            <tr>
                                <td>${task.name}</td>
                                <td>${task.location}</td>
                                <td>${task.type}</td>
                                <td class="${statusClass}">${task.status}</td>
                                <td class="${impactClass} fw-bold">${task.traffic_impact}</td>
                                <td class="${priorityClass}">${priorityText}</td>
                                <td>${task.start_time || '未定'}</td>
                                <td>${task.end_time || '未定'}</td>
                                <td>
                                    <a href="/task/${task.id}" class="btn btn-sm btn-primary">详情</a>
                                    <button class="btn btn-sm btn-info locate-task" data-lat="${task.latitude}" data-lng="${task.longitude}">定位</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                tableBody.innerHTML = tableHtml;
                
                // 绑定定位按钮事件
                document.querySelectorAll('.locate-task').forEach(button => {
                    button.addEventListener('click', function() {
                        const lat = parseFloat(this.getAttribute('data-lat'));
                        const lng = parseFloat(this.getAttribute('data-lng'));
                        map.setView([lat, lng], 13);
                    });
                });
            }
            
            // 设置状态筛选器事件监听
            document.querySelectorAll('#filter-status-active, #filter-status-pending, #filter-status-completed, #filter-status-canceled').forEach(checkbox => {
                checkbox.addEventListener('change', renderTableData);
            });
            
            // 更新地图标记函数
            function updateMapMarkers(data) {
                // 清除现有标记
                markerClusterGroup.clearLayers();
                tasksLayer.clearLayers();
                
                // 获取状态筛选条件
                const showActive = document.getElementById('filter-status-active').checked;
                const showPending = document.getElementById('filter-status-pending').checked;
                const showCompleted = document.getElementById('filter-status-completed').checked;
                const showCanceled = document.getElementById('filter-status-canceled').checked;
                
                // 筛选要显示的任务
                const filteredTasks = data.tasks.filter(task => {
                    if (task.status === '进行中' && showActive) return true;
                    if (task.status === '待处理' && showPending) return true;
                    if (task.status === '已完成' && showCompleted) return true;
                    if (task.status === '已取消' && showCanceled) return true;
                    return false;
                });
                
                // 重新处理任务标记
                processTasks(filteredTasks);
                
                // 重新筛选任务
                filterTasks();
            }
            
            // 处理窗口大小变化
            window.addEventListener('resize', function() {
                map.invalidateSize();
            });
        }
    });
</script>
{% endblock %} 